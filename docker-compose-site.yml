version: '3.3'
networks:
    processmaker:
volumes:
    docker-data:
services:
    docker:
        image: docker:20-dind
        privileged: true
        ports:
            - '2375:2375'
        networks:
            - processmaker
        volumes:
            - docker-data:/var/lib/docker
            - ./scripts:/opt/scripts
        environment:
            DOCKER_DRIVER: "overlay2"
            DOCKER_TLS_CERTDIR: ""
        restart: always
        healthcheck:
            test: [ 'CMD', 'docker', 'info' ]
            interval: 30s
            timeout: 10s
            retries: 5
    processmaker:
        image: processmaker/pm4-dev:4.3v1
        ports:
            - '80:80'
            - '6001:6001'
        depends_on:
            mysql:
                condition: service_healthy
            redis:
                condition: service_healthy
            docker:
                condition: service_healthy
        networks:
            - processmaker
        volumes:
            - ./processmaker:/var/www
            - ./.env:/opt/.env
            - ./scripts:/var/www/storage/scripts
        environment:
            PM_branch: '4.3.0+patch-3-les-schwab'
            WAIT_FOR_DEPENDENTS: 0
            DOCKER_HOST: 'tcp://docker:2375'
            NO_PROXY: "127.0.0.1,localhost,docker:2375"
